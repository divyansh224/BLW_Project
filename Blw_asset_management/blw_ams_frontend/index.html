<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    const user = localStorage.getItem("user_id");
    if (!user) {
      window.location.href = "login.html";
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BLW Inventory Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sidebar { width: 260px; background: url("assets/1.jpeg") no-repeat center center; background-size: cover; color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .sidebar img { width: 100px; margin-bottom: 20px; }
    .sidebar h2 { font-size: 1.3rem; margin-bottom: 20px; text-align: center; background-color: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 5px; }
    .menu a { width: 100%; text-align: center; margin: 5px 0; padding: 10px; color: white; text-decoration: none; background-color: rgba(183, 28, 28, 0.8); border-radius: 5px; transition: background-color 0.3s; display: block; }
    .menu a:hover { background-color: rgba(229, 57, 53, 0.9); }
    .main { flex: 1; padding: 30px; background-color: #f8f9fa; overflow-y: auto; }
    h1 { font-size: 1.8rem; margin-bottom: 20px; }
    #searchInput { padding: 10px; width: 100%; max-width: 400px; margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 4px; }
    table { width: 100%; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.05); margin-bottom: 40px; }
    th { background-color: #d32f2f; color: white; padding: 12px; text-align: left; }
    td { padding: 12px; vertical-align: middle; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    input[type="number"] { width: 80px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .details-link { color: #0d6efd; text-decoration: underline; cursor: pointer; }
    #details-page { padding: 30px; }
    .details-header { display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 20px; }
    .details-header img { width: 80px; }
    .details-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .details-buttons { margin-top: 30px; display: flex; gap: 10px; }

    #pdf-content {
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background: white;
  font-size: 16px; /* Scales better when captured */
}

@media print {
  body {
    margin: 0;
    padding: 0; 
  print-color-adjust: exact;
  -webkit-print-color-adjust: exact;
 }

  .details-buttons {
    display: none;
  }

  #pdf-content {
    page-break-inside: avoid;
  }
}
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="assets/logo.png" alt="BLW Logo">
    <h2>BLW Inventory</h2>
    <div class="menu" id="sidebar-menu"></div>
  </div>

  <div class="main">
    <div id="inventory-view">
      <button onclick="goBack()" class="btn btn-danger mb-3" style="display:none;" id="backButton">‚Üê Back to All Departments</button>
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 id="dept-title" class="mb-0">All Department Inventory Overview</h1>
          <button id="addAssetBtn" onclick="openAddAssetModal()" class="btn btn-success" style="display:none;">+ Add New Asset</button>
      </div>
      <input type="text" id="searchInput" onkeyup="filterTables()" placeholder="Search all items...">
      <div id="no-results" style="display: none;">No items found.</div>
      <div id="table-container">
        <div id="overview"></div>
      </div>
    </div>

    <div id="details-page" style="display: none;">
      <div id="pdf-content">
        <div class="details-header">
          <img src="assets/logo.png" alt="Logo">
          <div>
            <h1>Item Details</h1>
            <h2 id="detail-item-name-header"></h2>
          </div>
        </div>
        <div class="details-info-grid">
          <div>
            <h3>ITEM INFORMATION</h3>
            <p><strong>Department:</strong> <span id="detail-department"></span></p>
            <p><strong>Quantity:</strong> <span id="detail-quantity"></span></p>
          </div>
          <div>
            <h3>LIFECYCLE DATES</h3>
            <p><strong>Date of Manufacturing:</strong> <span id="detail-mfg-date"></span></p>
            <p><strong>Warranty Until:</strong> <span id="detail-warranty"></span></p>
            <p><strong>Last Maintenance:</strong> <span id="detail-last-maint"></span></p>
            <p><strong>Next Maintenance:</strong> <span id="detail-next-maint"></span></p>
          </div>
        </div>
      </div>
      <div class="details-buttons">
        <button onclick="hideDetails()" class="btn btn-secondary">‚Üê Back to Inventory</button>
        <button onclick="printDetailsAsPDF()" class="btn btn-primary">üñ®Ô∏è Print to PDF</button>
      </div>
    </div>
  </div>

  <div id="addAssetModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="document.getElementById('addAssetModal').style.display='none'">&times;</span>
      <h3>Add New Asset</h3>
      <form id="addAssetForm" onsubmit="event.preventDefault(); addNewAsset();">
        <div class="mb-3">
          <label for="newAssetDepartment" class="form-label">Department</label>
          <select id="newAssetDepartment" class="form-select" required></select>
        </div>
        <div class="mb-3">
          <label for="newAssetItem" class="form-label">Item Name</label>
          <input type="text" id="newAssetItem" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="newAssetQuantity" class="form-label">Quantity</label>
          <input type="number" id="newAssetQuantity" class="form-control" value="1" min="1" required>
        </div>
        <button type="submit" class="btn btn-primary">Save Asset</button>
      </form>
    </div>
  </div>

  <button onclick="logout()" class="btn btn-danger" style="position: fixed; top: 20px; right: 20px;">Logout</button>

  <script>
    const department = localStorage.getItem('department');
    const user_id = localStorage.getItem('user_id');
    const role = localStorage.getItem('role');

    const overviewDiv = document.getElementById("overview");
    const sidebarMenu = document.getElementById("sidebar-menu");
    let latestItems = {};

    const departments = [
      "Design Department", "Electronic Data Processing (EDP)", "General Administration",
      "Loco Training School (LTS)", "Planning Department", "Safety Department",
      "Stores Department", "Technical Training Centre (TTC)"
    ];

    async function fetchInventory(dept) {
      const res = await fetch(`http://localhost:3000/inventory/${encodeURIComponent(dept)}`);
      return res.ok ? await res.json() : [];
    }

    async function updateInventory(dept, item, quantity) {
      await fetch('http://localhost:3000/inventory/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ department: dept, item, quantity: parseInt(quantity) })
      });
    }

    async function addAssetAPI(dept, item, quantity) {
      const response = await fetch('http://localhost:3000/inventory/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ department: dept, item, quantity: parseInt(quantity) })
      });
      if (!response.ok) {
        alert('Error: Could not add asset.');
        return false;
      }
      return true;
    }

    function openAddAssetModal() {
      const deptSelect = document.getElementById('newAssetDepartment');
      deptSelect.innerHTML = '';
      if (isAdmin) {
        deptSelect.disabled = false;
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          deptSelect.appendChild(option);
        });
      } else {
        deptSelect.disabled = true;
        const option = document.createElement('option');
        option.value = department;
        option.textContent = department;
        deptSelect.appendChild(option);
      }
      document.getElementById('addAssetForm').reset();
      document.getElementById('addAssetModal').style.display = 'block';
    }

    async function addNewAsset() {
      const dept = document.getElementById('newAssetDepartment').value;
      const item = document.getElementById('newAssetItem').value;
      const quantity = document.getElementById('newAssetQuantity').value;
      if (!dept || !item || !quantity) return alert('Please fill out all fields.');
      
      const success = await addAssetAPI(dept, item, quantity);
      if (success) {
        document.getElementById('addAssetModal').style.display = 'none';
        alert('Asset added successfully!');
        isAdmin ? renderOverview() : showDepartment(department);
      }
    }

    function renderSidebar() {
      sidebarMenu.innerHTML = '<a href="maintenance.html">Maintenance</a>';
      if (isAdmin) {
        departments.forEach(dept => {
          const link = document.createElement("a");
          link.textContent = dept;
          link.onclick = () => showDepartment(dept);
          sidebarMenu.appendChild(link);
        });
      } else if (department) {
        const link = document.createElement("a");
        link.textContent = department;
        link.onclick = () => showDepartment(department);
        sidebarMenu.appendChild(link);
      }
    }

    async function renderOverview() {
      hideDetails();
      overviewDiv.innerHTML = "";
      if (isAdmin) {
        document.getElementById("dept-title").textContent = "Admin Panel: All Departments";
        for (const dept of departments) {
          const items = await fetchInventory(dept);
          latestItems[dept] = items;
          const rows = items.map((i, index) =>
            `<tr>
              <td>${i.item}</td>
              <td>${i.quantity}</td>
              <td><button class="btn btn-sm btn-outline-secondary" onclick="showDetailsByIndex('${dept}', ${index})">Details / Print</button></td>
            </tr>`).join("");
          overviewDiv.innerHTML += `
            <div class="department-section">
              <h3>${dept}</h3>
              <button class="btn btn-primary mb-2" onclick="printPDF('${dept}')">Print Department Report</button>
              <table class="table table-bordered inventoryTable">
                <thead><tr><th>Item</th><th>Quantity</th><th>Actions</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>`;
        }
      } else if (department) {
        showDepartment(department);
      } else {
        overviewDiv.innerHTML = `<p class="text-danger">üö´ Invalid department or not logged in.</p>`;
      }
    }

    async function showDepartment(dept) {
      hideDetails();
      document.getElementById("dept-title").textContent = dept;
      const container = document.getElementById("table-container");
      const items = await fetchInventory(dept);
      latestItems[dept] = items;
      const rows = items.map((item, index) =>
        `<tr>
          <td>${item.item}</td>
          <td><input type='number' class='form-control' value='${item.quantity}' onchange='updateInventory("${dept}", "${item.item}", this.value)' /></td>
          <td><button class="btn btn-sm btn-outline-secondary" onclick="showDetailsByIndex('${dept}', ${index})">Details / Print</button></td>
        </tr>`).join("");

      container.innerHTML = `
        <div class="department-section">
          <h3>${dept}</h3>
          <button class="btn btn-primary mb-2" onclick="printPDF('${dept}')">Print Department Report</button>
          <table class="table table-bordered inventoryTable">
            <thead><tr><th>Item</th><th>Quantity</th><th>Actions</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      if (isAdmin) {
        document.getElementById("backButton").style.display = "inline-block";
      }
    }

    function goBack() {
      document.getElementById("dept-title").textContent = "Department Inventory Overview";
      document.getElementById("table-container").innerHTML = '<div id="overview"></div>';
      renderOverview();
      document.getElementById("backButton").style.display = "none";
    }

    function filterTables() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const sections = document.querySelectorAll(".department-section");
        let anyResults = false;

        sections.forEach(section => {
            const table = section.querySelector(".inventoryTable tbody");
            let sectionHasVisibleRows = false;
            
            Array.from(table.rows).forEach(row => {
                const item = row.cells[0].textContent.toLowerCase();
                if (item.includes(input)) {
                    row.style.display = "";
                    sectionHasVisibleRows = true;
                    anyResults = true;
                } else {
                    row.style.display = "none";
                }
            });
            section.style.display = sectionHasVisibleRows ? "" : "none";
        });
        document.getElementById("no-results").style.display = anyResults ? "none" : "block";
    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    function showDetailsByIndex(dept, index) {
      const itemObj = latestItems[dept][index];
      showDetails(dept, itemObj);
    }

    function showDetails(dept, itemObj) {
      document.getElementById("inventory-view").style.display = "none";
      document.getElementById("details-page").style.display = "block";
      document.getElementById("detail-item-name-header").textContent = itemObj.item;
      document.getElementById("detail-department").textContent = dept;
      document.getElementById("detail-quantity").textContent = itemObj.quantity;
      document.getElementById("detail-mfg-date").textContent = itemObj.mfg_date || "N/A";
      document.getElementById("detail-warranty").textContent = itemObj.warranty_unto || "N/A";
      document.getElementById("detail-last-maint").textContent = itemObj.last_maintenance || "N/A";
      document.getElementById("detail-next-maint").textContent = itemObj.next_maintenance || "N/A";
    }

    function hideDetails() {
      document.getElementById("details-page").style.display = "none";
      document.getElementById("inventory-view").style.display = "block";
    }

    
    // eogjnrougbsaelbn
     function printDetailsAsPDF() {
  const detailsPage = document.getElementById('pdf-content');
  const itemName = document.getElementById('detail-item-name-header').textContent.trim().replace(/ /g, '_');

  html2canvas(detailsPage, { scale: 2, useCORS: true }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf; // üëà this line is essential now
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();

    const canvasRatio = canvas.width / canvas.height;
    let width = pdfWidth - 40;
    let height = width / canvasRatio;

    if (height > pdfHeight - 40) {
      height = pdfHeight - 40;
      width = height * canvasRatio;
    }

    const x = (pdfWidth - width) / 2;
    const y = 20;

    pdf.addImage(imgData, 'PNG', x, y, width, height);
    pdf.save(`${itemName}_details.pdf`);
  });
}
    function printPDF(dept) {
      window.open(`http://localhost:3000/reports/inventory/${encodeURIComponent(dept)}/pdf`, '_blank');
    }

    const isAdmin = role === "Admin" && user_id === "admin" && department === "Administration";
    
    renderSidebar();
    renderOverview();

    if (user_id) {
      document.getElementById('addAssetBtn').style.display = 'block';
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>